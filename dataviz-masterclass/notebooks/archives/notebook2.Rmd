---
title: "Dataviz Notebook"
output: html_notebook
---
```{r}
library(tidyverse)
```


Lecture
```{r}
f <- read.csv2("../data/obs_artif_conso_com_2009_2020_V2.csv", sep=",", encoding = "UTF-8")

```

Colonnes utiles

Stats départementales
```{r}
statDep <- f %>% 
  group_by(iddep, iddeptxt) %>% 
  summarize(artact0920 = sum(artact0920),
            arthab0920 = sum(arthab0920),
            artmix0920 = sum(arthab0920),
            artinc0920 = sum(arthab0920)) %>% 
  ungroup() %>%
  data.frame()

```

Stats régionales
```{r}
statReg <- f %>% 
  group_by(idreg, idregtxt) %>% 
  summarize(artact0920 = sum(artact0920),
            arthab0920 = sum(arthab0920),
            artmix0920 = sum(artmix0920),
            artinc0920 = sum(artinc0920)) %>% 
  ungroup() %>%
  data.frame()

```

!! Préparation des données
Préparation des données
```{r}
statReg2 <- gather(statReg, 
       "variable", 
       "flux", 
       c("artact0920", "arthab0920", "artmix0920", "artinc0920"))
```

Représentation en barres

```{r}
library(ggplot2)

ggplot(data = statReg2, aes(x = idregtxt, y = flux, fill = variable)) +
  geom_bar(stat = "identity", position = "stack") # on change le type ici
```

On crée le plot mais en horizontal :
```{r}
library(ggplot2)

ggplot(data = statReg2, 
       aes(x = idregtxt, 
           y = flux, 
           fill = variable)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip()
```
On effectue encore quelques modifications :
```{r}
library(ggplot2)

statReg2$idregtxt <- factor(statReg2$idregtxt, levels = sort(unique(statReg2$idregtxt), decreasing = TRUE))

statReg2$variable <- factor(statReg2$variable, levels = c("arthab0920","artact0920", "artmix0920", "artinc0920"))

ggplot(data  = statReg2, 
       aes(x = idregtxt, 
           y = flux, 
           fill = variable)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  theme(
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank()) +
  scale_fill_discrete( # !! scale_fill
  name = "Flux\nd'artificialisation\n2009-2020",
  labels = c("Habitat", "Activité", "Mixte", "Inconnu")
  )
```


Couleurs
Sélectionnons d'autres couleurs, plus neutres. Pour cela, utilisons la modélisation des couleurs Hue Chroma Luminance

http://hclwizard.org:3000/hclcolorpicker/

Le type de couleur est défini par hue, ou la teinte.  

- Pour le type activité, nous choisirons la couleur <span style='color:red'>rouge</span> (hue de 5)
- Pour le type habitat, la couleur <span style='color:red'>rouge</span> (hue de 220)
- pour le type mixte, la couleur magenta (en quelque sorte un mélange du rouge et du bleu) (hue de 270)
- Nous représenterons le type inconnu par du gris

Nous choisissons un chroma de 30 (chroma va de 0 à 360 pour les couleurs les plus vives). Gris a un chroma de 0.   
Nous choisissons une luminance de 80 (la luminosité va de 0 à 100 pour les couleurs les plus lumineuses).

En affectant les mêmes niveaux de chroma et de luminance, nous obteons une palette homogène.

```{r}
getColorForHue <- function(h, c = 50, l = 80) {
  hcl(h = h, c = c, l = l, fixup = TRUE)
}

colorBlue <- getColorForHue(220)
colorRed <- getColorForHue(4)
colorMagenta <- getColorForHue(300)
colorGrey <- hcl(h = 0, c = 0, l = 80, fixup = TRUE)

palette <- c(colorBlue, colorRed, colorMagenta, colorGrey)
names(palette) <- c("blue", "red", "magenta", "grey")

demoplot(palette, "bar")
```
Voici une représentation des couleurs :

```{r}
hclplot(palette)
```

Refaisons le plot, mais avec ces nouvelles couleurs :
```{r}
library(ggplot2)

ggplot(data  = statReg2, 
       aes(x = idregtxt, 
           y = flux, 
           fill = variable)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  theme(
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.title=element_text(size = 8),
        legend.text=element_text(size = 8)) +
scale_fill_manual(
  name = "Flux\nd'artificialisation\n2009-2020",
  labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
  values = c(colorBlue, colorRed, colorMagenta, colorGrey)
  )
```
Les zones mixtes sont peu lisibles. Utilisons un chroma plus conséquent pour cette couleur :
```{r}
library(ggplot2)

ggplot(data  = statReg2, 
       aes(x = idregtxt, 
           y = flux, 
           fill = variable)) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  theme(
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        legend.title=element_text(size = 8),
        legend.text=element_text(size = 8)) +
scale_fill_manual(
  name = "Flux\nd'artificialisation\n2009-2020",
  labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
  values = c(colorBlue, colorRed, getColorForHue(h = 300, c = 100), colorGrey)
  )
```


## Représentation en barres par département pour une région

Faisons le même graphique, mais pour tous les départements de Provence.

Transformons nos stats départementales.

Nous allons en profiter pour rendre les choses un peu plus génériques.

Tout d'abord, les deux premières colonnes correspondent aux code et libellés. Les autres colonnes concernent les flux.

```{r}
statDep2 <- gather(statDep, 
       "variable", 
       "flux", 
       c("artact0920", "arthab0920", "artmix0920", "artinc0920"))

statDep3 <- statDep2 %>% rename(code = 1, libelle = 2)
```

Nous trions les niveaux de facteurs car ceux-ci déterminent l'ordre dans lequel les éléments sont affichés dans le graphique.

Nous souhaitons régler l'affichage des entités selon leur nom (départements ou régions), ainsi que celui des variables (flux d'habitat, activité, ...)

!!!

Créons une fonction qui produit le graphique sur la base de ce data frame générique. On reprend le code précédent :
```{r}
makePlot <- function(df) {
  
  # Relevel
  df$libelle <- as.character(df$libelle)
  df$libelle <- factor(df$libelle, levels = sort(unique(df$libelle), decreasing = TRUE))

  df$variable <- as.character(df$variable)
  df$variable <- factor(df$variable, levels = c("arthab0920","artact0920", "artmix0920", "artinc0920"))
  
  # Colors
  colorBlue <- getColorForHue(220)
  colorRed <- getColorForHue(4)
  colorMagenta <- getColorForHue(h = 300, c = 100)
  colorGrey <- hcl(h = 0, c = 0, l = 80, fixup = TRUE)
  palette <- c(colorBlue, colorRed, colorMagenta, colorGrey)

  # Plot
  ggplot(data  = df, 
         aes(x = libelle, 
             y = flux, 
             fill = variable)) +
    geom_bar(stat = "identity", position = "stack") +
    coord_flip() +
    theme(
          axis.ticks.y = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.background = element_blank(),
          panel.border = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
  scale_fill_manual(
    name = "Flux\nd'artificialisation\n2009-2020",
    labels = c("Habitat", "Activité", "Mixte", "Inconnu"),
    values = palette
    )
}

makePlot(statDep3 %>% filter(code %in% c("04", "05", "06", "13", "83", "84")))
```

Nous pouvons utiliser cette fonction sur les stats régionales :

```{r}
statReg2 %>% rename(code = 1, libelle = 2) %>% makePlot()
```
On peut donc utiliser la même fonction sur n'importe quel fichier statistiques de flux. Nous pourrions aussi l'utiliser sur des communes :

!!!
!! data2viz
!! styles
## Représentation en treemap
La représentation en treemap est pas mal pour présenter les flux d'artificialisation sur une commune.

Prenons par exemple la commune d'Aix en Provence :
```{r}
fAix <- f %>% filter(idcom == "13001") %>% select("arthab0920", "artact0920", "artmix0920", "artinc0920")
fAix
```

Le package plotly permet de créer ce style de représentation

treemap attend ... !!!

```{r}
library(plotly)

labels = c("Habitat", "Activité", "Mixte", "NC") # !! NC
parents = c("", "", "", "")
values = as.numeric(fAix)

fig <- plot_ly(
  type = "treemap",
  labels = labels,
  parents = parents,
  values = values,
  marker = list(colorscale='Reds'))

fig
```

!!! pour plusieurs communes

Représentation en streamgraph

Voyons l'évolution au cours du temps des flux